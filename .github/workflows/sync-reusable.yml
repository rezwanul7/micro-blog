name: Sync to App Repo

on:
  workflow_dispatch:
    inputs:
      source-branch:
        description: "Source branch to sync from"
        required: true
        default: "main"
      target-repo:
        description: "Owner/Repo of the target repository"
        required: true
      target-branch:
        description: "Target branch to sync to"
        required: true
        default: "main"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure PAT exists
        run: |
          if [ -z "${{ secrets.DESTINATION_REPO_PAT }}" ]; then
            echo "❌ ERROR: DESTINATION_REPO_PAT secret is not set!"
            exit 1
          else
            echo "✅ PAT is provided"
          fi

      - name: Echo last 4 chars of PAT secret
        run: echo "${{ secrets.DESTINATION_REPO_PAT }}" | rev | cut -c1-4 | rev

      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.source-branch }}

      - name: Clone target repo
        run: git clone https://${{ secrets.DESTINATION_REPO_PAT }}@github.com/${{ inputs.target-repo }} target-repo

      - name: Sync source into target
        run: |
          cd target-repo
          git checkout -B ${{ inputs.target-branch }} origin/${{ inputs.target-branch }} || git checkout -b ${{ inputs.target-branch }}
          git pull ../ ${{ inputs.source-branch }}  # relative path to source repo in root
          git push origin ${{ inputs.target-branch }} --force